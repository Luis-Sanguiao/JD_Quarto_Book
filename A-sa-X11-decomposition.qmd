# SA: X-11 Decomposition {.unnumbered}

## Context of use

-   seasonal adjustment with X-13-Arima second step

-   stand alone X-11 decomposition classical data

-   extended X11 for any frequency data (differences in access: no GUI, display and user-friendliness)

## Tools for X-11 decomposition

| Algorithm              | Access in GUI | Access in R (v2) | Access in R v3 |
|------------------------|---------------|------------------|----------------|
| X-13 Arima             | yes           | RJDemetra        | rjd3x13        |
| X11 decomposition only | yes           | RJDemetra        | rjd3x13        |
| Extended X11           | no            | no               | rjd3x11plus    |

## X-11 Decomposition

Here main module, not extended Extended in HF Chapter (see this...)

This part explains how to use X-11 decomposition algorithm, via R as well as via GUI. The algorithm itself is explained in more details [here](M-X11-decomposition.qmd)

In a nutshell, X-11 will de decompose the **linearized series** using iteratively different moving averages. The effects of pre-treatment will be reallocated at the end.

The sections below (will) describe

-   specifications needed to run X-11

-   generated output

-   series

-   diagnostics

-   final parameters

-   user-defined parameters

### Default specifications

The default specifications for X-11 must be chosen at the starting of the SA processing. They are detailed in the [Reg-Arima part](A-sa.qmd#Pre-treatment:%20Reg-ARIMA%20(or%20Tramo)). X-11 can be run without pre-treatment

### Quick Launch

#### From GUI

With a workspace open, an SAProcessing created and open data provider:

-   choose a default specification

-   drop your data and press green arrow

#### In R

In version 2

```{r,eval=FALSE}

library("RJDemetra")
model_sa_v2 <- x13(raw_series, spec ="RSA5c")

```

The model_sa_2 R object (list of lists) contains all parameters and results. Its structure is detailed here (R packages chapter, rjdemetra).

In version 3

```{r,eval=FALSE}

library("rjd3toolkit")
library("rjd3x13")
model_sa <- rjd3x13::x13(y_raw, spec = "RSA5")

```

The model_sa_3 R object (list of lists) contains all parameters and results. Its structure is detailed here (R packages chapter, rjd3x13).


### Retrieve series

#### Display in GUI

Final components from the SA Process are displayed in Main results (link to gui chapter) Panel
They contain the re-allocated pre-adjustment effects (link) of outliers (link) or external regressors (link).

![](All_images/SA_MainResults_Series.png)

(forecasts are added at the end of the ser, values in *italic*)

Detailed results from decomposition are displayed in Decomposition(X-11) node
(link to output tables detail here)

![](All_images/RDimage41.png)

They contain the re-allocated pre-adjustment effects (link) of outliers (link) or external regressors (link)

specifically (write formulas)
- D12...

Output series can be exported out of GUI by two means:

-   generating [output files directly with interactive menus (T-GUI-Output.qmd)

-   running the cruncher to generate those files as described [here](T-Production-tools-cruncher-QR.qmd)

#### Retrieve in R

In version 2

```{r,eval=FALSE}

# final components
model_sa$final$series
# final forecasts y_f sa_f s_f t_f i_f
model_sa$final$forecasts
# from user defined output 
```

Detailed X-11 tables have to be pre-specified by the user in user defined output.

```{r,eval=FALSE}
# from user defined output 
```



In version 3

```{r,eval=FALSE}

# final components
model_sa$final$series
# final forecasts y_f sa_f s_f t_f i_f
model_sa$final$forecasts
# from user defined output 
```






### Retrieve Diagnostics

X11 produces the following type diagnostics or quality measures

#### SI-ratios

##### Display in GUI

NODE Main Results \> SI-Ratios

![Text](All_images/SA_MainResults_SI_ratios.png)

In GUI all values cannot be retrieved

##### Retrieve in R

In version 2

```{r, eval=FALSE}
# data frame with values 
model_sa$decomposition$si_ratio
# customizable plot
plot(model_sa, type= "cal-seas-irr",first_date = c(2015, 1))

```

#### M-statistics

At the end of the decomposition, X-11 algorithm provides quality measure of the decomposition called "M statistics": 11 statistics (M1 to M11) and 2 summary indicators (Q et Q-M2). By design $0<M_x<3$ and acceptance region is $M_x \leq 1$

-   **M1** The relative contribution of the irregular over three months span
-   **M2** The relative contribution of the irregular component to the stationary portion of the variance
-   **M3** The amount of month to month change in the irregular component as compared to the amount of month to month change in the trend-cycle (I/C-ratio)
-   **M5** MCD (Months for Cyclical Dominance): The number of months it takes the change in the trend-cycle to surpass the amount of change in the irregular
-   **M6** The amount of year to year change in the irregular as compared to the amount of year to year change in the seasonal (only valid for 3x5 seasonal filter)
-   **M7** The amount of moving seasonality present relative to the amount of stable seasonality
-   **M8** The size of the fluctuations in the seasonal component throughout the whole series
-   **M9** The average linear movement in the seasonal component throughout the whole series
-   **M10** Same as 8, calculated for recent years only (4 years, N-2 to N-5)
-   **M11** Same as 9, calculated for recent years only

The $Q$ statistic is a composite indicator calculated from the $M$ statistics.

$$Q = \frac{10M1 + 11M2 + 10M3 + 8M4 + 11M5 + 10M6 + 18M7 + 7M8 + 7M9 + 4M10 + 4M11}{100}$$

$Q = Q - M2$ (also called $Q2$) is the $Q$ statistic for which the $M2$ statistics was excluded from the formula, i.e.:

$$Q - M2 = \frac{10M1 + 10M3 + 8M4 + 11M5 + 10M6 + 18M7 + 7M8 + 7M9 + 4M10 + 4M11}{89}$$

If a time series does not cover at least 6 years, the $M8$, $M9$, $M10$ and $M11$ statistics cannot be calculated. In this case the $Q$ statistic is computed as:

$$Q = \frac{14M1 + 15M2 + 10M3 + 8M4 + 11M5 + 10M6 + 32M7}{100}$$

The model has a satisfactory quality if the $Q$ statistic is lower than 1.

##### Display in GUI

To display results in GUI, expand NODE

Decomposition(X-11) \> Quality Measures \> Summary

Results displayed in red indicate that the test failed.

![Text](All_images/RDimage46.png)

##### Retrieve in R

In version 2

```{r, eval=FALSE}
# this code snippet is not self-sufficient 
model_sa$decomposition$mstats
```

#### Detailed Quality measures

In GUI all the diagnostics below can be displayed expanding the NODE

Decomposition(X-11) \> Quality Measures \> Details

They are detailed in the [X-11 method chapter](M-X11-decomposition.qmd)

In R (to be added)

### Retrieve final parameters

This section describes the parameters which are automatically chosen by the software as a result of the estimation process. They have no default value.

Final trend filter: length of Henderson filter applied for final estimation (in the second part of the D step).

Final seasonal filer: length of Henderson filter applied for final estimation (in the second part of the D step).

#### Display in GUI

Node Decomposition(X11) \> Final Filters

#### Retrieve in R

In version 2

```{r, eval=FALSE}

model_sa$decomposition$s_filter
model_sa$decomposition$t_filter

```

### User-defined parameters

The following sections describe how to change default values or automatic choices.

##### General settings

-   **Mode**

-   **Seasonal component**

-   **Forecasts horizon**

Length of the forecasts generated by the Reg-Arima model - in months (positive values) - years (negative values) - if set to is set to 0, the X-11 procedure does not use any model-based forecasts but the original X-11 type forecasts for one year. - default value: -1, thus one year from the Arima model

-   **Backcasts horizon**

Length of the backcasts generated by the Reg-Arima model - in months (positive values) - years (negative values) - default value: 0

##### Irregular correction

-   **LSigma**

    -   sets lower sigma (standard deviation) limit used to down-weight the extreme irregular values in the internal seasonal adjustment iterations
    -   values in $[0,Usigma]$
    -   default value is 1.5

-   **USigma**

    -   sets upper sigma (standard deviation)
    -   values in $[Lsigma,+\infty]$
    -   default value is 2.5

-   **Calendarsigma**

    -   allows to set different **LSigma** and **USigma** for each period
    -   values
        -   None (default)
        -   All: standard errors used for the extreme values detection and adjustment computed separately for each calendar month/quarter
        -   Signif: groups determined by Cochran test (check)
        -   Sigmavec: set two customized groups of periods

-   **Excludeforecasts**

    -   ticked: forecasts and backcasts from the Reg-Arima model not used in Irregular Correction
    -   unticked (default): forecasts and backcasts used

##### Seasonality extraction filters choice

Specifies which be used to estimate the seasonal factors for the entire series.

-   **Seasonal filter**

-   default value: *MSR* (Moving seasonality ratio), automatic choice of final seasonal filter, initial filters are $3\times 3$

-   choices: $3\times 1$, $3\times 3$, $3\times 5$, $3\times 9$, $3\times 15$ or Stable

-   "Stable": constant factor for each calendar period (simple moving average of a all $S+I$ values for each period)

User choices will be applied to final phase D step.

The seasonal filters can be selected for the entire series, or for a particular month or quarter.

-   **Details on seasonal filters**

Sets different seasonal filters by period in order to account for seasonal heteroskedasticity (link to M chapter)

-   default value: empty

##### Trend estimation filters

-   **Automatic Henderson filter** our user-defined

    -   default: length 13
    -   unticked: user defined length choice

-   **Henderson filter** length choice

    -   values: odd number in $[3,101]$
    -   default value: 13

Check: will user choice be applied to all steps or only to final phase D step

#### Parameter setting in GUI

All the parameters above can be set with in the specification box.

#### Parameter setting in R packages

In version 2

```{r eval=FALSE}
#Creating a modified specification, customizing all available X11 parameters
modified_spec<- x13_spec(current_sa_model,
    #x11.mode="?",
    #x11.seasonalComp = "?",
    x11.fcasts = -2,
    x11.bcasts = -1,
    x11.lsigma = 1.2,
    x11.usigma = 2.8,
    x11.calendarSigma = NA, 
      x11.sigmaVector = NA,
    x11.excludeFcasts = NA
    # filters 
    x11.trendAuto = NA, 
    x11.trendma = 23,
    x11.seasonalma = "S3X9)

#New SA estimation: apply modified_spec

modified_sa_model<-x13(raw_series,modified_spec)

```

how to retrieve all user defined params: done or not ?

